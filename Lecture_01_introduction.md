# 今日のゴール
* Stataでの解析でプログラミングする必要性を理解する。
* Stataプログラミングにはさまざまな方法がることを理解する。
* 計算機を使用した再現可能な研究を行なうためのルールを理解する。

# Stataとは何か？　そして、何でないか？
* 統計解析に関する統合環境である（Integrated Development Environment）  
* 解析を行うだけではなく、データマネジメントやプロジェクトマネジメントが行える。
* 統計解析ソフトではない。
* 統計解析を行うだけのソフトではない。
* 統計教本である。
* 詳細なマニュアルが揃っている。
* これらを読むだけで、かなりの力量がつく（と思う）。
* 表計算ではない。

# Stataの特徴
## コマンドが豊富にある
Stata1.0（および1.1）では44個のコマンドがあるのみでしたが、Stata17ではかなり膨大な数まで増えています。とはいえ、自分のやりたい公式コマンドが全て揃うとは限りません。そのような場合は、user-driven commandを探せばだいたい見つかります。  
```
// コマンドウィンドウでの探し方
findit keyword
serch keyword
```
それでも見つからないときは、ネットで検索してください。公式の下記サイト参考になると思います。

* [Statalist](https://www.statalist.org/forums/)
* [UCLA](https://stats.oarc.ucla.edu/stata/)
* [Stata FAQ](https://www.stata.com/support/faqs/)
* [Stataグラフギャラリー](https://www.lightstone.co.jp/stata/techinfo/graphs_overview1.html)

## インストールが手軽
RやPythonと異なって、インストールするときに手間がほとんどかかりません。

また、高速化についても自分自身で何か行なう必要なありません（高価なバージョンをインストールすれば良い）。

## Pythonとの連携を開始
Stata16からはプログラミング言語Pythonとの連携をはじめ、StataからPythonが使える様になりました。Stata17ではJupyter notebookからStataが利用出来るようになりました。

# この講義シリーズの目的
プログラミングをキチンと行うことを目的としています。

一口にStataプログラミングといっても幾つかのレベルがあります。

* do-file
* programコマンド
* ado-file
* Mata
* Python

## do-fileを使ったprograming
レベル1として、do-fileを使って解析を進めることが必要です。コンピュータは、繰り返し作業に強いので、一度do-fileを組めば再利用することで、効率的な作業が可能です。

よく見せて頂いているdo fileは、1つのファイルに全ての挙動を含んでしまっていますが、モジュール化することが望ましいと考えます。

また、このような作業は、研究の再現性の確保やプロセスの文書化に繋がります。

## programコマンドを用いたprograming
レベル1.5として、`program`コマンドを紹介します。これは、まとまった一連の操作を実行するためのプログラムを定義するためのコマンドです。

下の例では、`hellow_stata`というプログラムを定義しました。

```stata
program define hello_stata
 display "Hello, Stata!"
 display "`1' is an excellent stata user!"
end
```

この定義した`hellow_stata'プログラムを実行すると、下記の様になります。

```stata
hello_stata foobar
```

> Hello, Stata!  
> foobar is an excellent stata user!

これは単に文字を表示させるだけのプラグラムですが、複雑なことをプログラム定義しておけば、解析の効率化に役立ちます。

## ado-fileを使ったprogramming
レベル2として、ado fileを作成することが挙げられます。ado fileは、Stataのコマンドの本体ともいえるファイルです。このファイルを自作することによって、Stataは更に効率的に柔軟性を持った操作をおこなうことができます。

なお、Stataでado fileで定義したコマンドを使うには、決められたフォルダにado fileを格納しておくことが必要です。格納先のフォルダは下記のコマンドで見ることが出来ます。
```stata
adopath
```

> [1]  (BASE)      "C:\Program Files\Stata17\ado\base/"  
> [2]  (SITE)      "C:\Program Files\Stata17\ado\site/"  
> [3]              "."  
> [4]  (PERSONAL)  "C:\Users\user\ado\personal/"  
> [5]  (PLUS)      "c:\ado\plus/"  
> [6]  (OLDPLACE)  "c:\ado/"  

コマンドの実行が命令されると、Stataはado fileをフォルダ1からフォルダ6まで探します。通常のコマンドは、1（BASE）に入っています。`ssc`を利用した場合は5（PLUS）にインストールされています。なお、自作のコマンドは4（PERSONAL）に入れておくと良いと思います。

ado fileを一から作成するのは大変ですが、既存のadoファイルを修正したり、改造することで自分の課題に合ったadoファイルを作成することもできます。

## MataやPythonを使ったprogramming
レベル3＋として、Stataでは、Stata内部から他の言語を呼び出して使うことを紹介します。

その中で古くから用いられているのが[Mata](https://www.stata.com/features/overview/introduction-to-mata/)です。Mataでは、スカラー、行列、文字列などさまざまなデータの計算を高速に行ないます。

Stata16からはPythonも実行できるようになりました。また、Stata17からは逆にPythonの実行環境でもStataを実行できるようになりました。Pythonは機械学習ライブラリが豊富ですので、Stataでの解析に機械学習結果を混ぜるなどの活用が今後増えると思われます。

# なぜプログラミングが必要なのか？
## 作業効率的な必要性
* 一度、作った統計解析プログラムを残しておく。
* 似たようなデータ解析を行う際に、プログラムの流用ができます
* GitHubなどで共有可能です（残念ながら、Stataの共有例は少ないです）
* 
## 倫理的な必要性
### 再現不可能な遺伝学
2006年のデューク大学の抗がん剤の関する臨床試験があり、腫瘍に対して良く効く抗腫瘍薬を特定出来るという研究成果（遺伝子型）でした。この内容に対して、生物統計家：Keith A. BaggerlyとKevin R. Coombesが検証しました。

しデューク大学の研究者から提供されたデータセットを調べて見たところ、下記のような問題点がありました。
* データが1つずつズレているところがある。
* 1人の患者が2回データセットに出てくる。
* 効く・効かないのカテゴリが逆になっている患者がいる。
* マイクロアレイ機器ごとに結果に有意なバラツキがあった。（どの機器を使うかによって、結果が異なる）
 
要は、しっちゃかめっちゃかで、問題しか無かったようです（[参考](http://projecteuclid.org/download/pdfview_1/euclid.aoas/1267453942)）。しかし、デューク大学の審査委員会はそれを見つけられず臨床試験は続けられました。

### 必要な対応
データや解析用コードを残してください。そして、解析用コードを公開し、「何か不都合なことを隠しているかも」と疑われないようにしてください。可能であれば、データ公開も行なって下さい。

## 再現可能な研究
[計算機を使用した再現可能な研究のための10個の簡単な規則](http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1003285)に記載されているルールには基本的に従うようにして下さい。ここでは10個のルールについて概説します。

### ルール1. すべての結果について、それがどのように生成されたのか記録する
一般的にraw dataからoutput tableまで多くのステップを踏むことがほとんどです。

Stataでは解析は1つのコマンドで実行可能ですが、その直前のコマンドの実行結果に依存することが良くあります。例えば、`regress`コマンドの後に実行する`predict`などがあります。

そのため、関係しているステップを全て記録しておく必要があります。そのために、do fileは有用です。

### ルール2．手作業ステップを避ける
手作業ステップは、出来るだけ避け、プログラム実行で実行します。

特に、小さなデータの修正をExcel上で行うことは最悪です。どのような理由で値をどのように変更したかが不明になってしまいます。

例えば、idが10番の人の変数varを変更するときには、下記のようなコードをdo fileに追加するのが良いと思います。

```stata
replace var = 1 if id == 10 // 誤入力によるデータ修正
```

### ルール3. 使用したプログラムの正確なバージョンを保存しておく
Stataのバージョンがわかるようにしておくことが必要です。do fileの最初に`version`コマンドで実行したStataのバージョンを指定しておいて下さい。

```stata
version 17
```

また、外部コマンドを利用する際には、外部コマンドのバージョンを記録したり、可能であれば外部コマンドのアーカイブを取っておくと良いでしょう。外部コマンドは、作者によって修正されますが、その修正によりoutputが変化するかもしれません。

このような時に「古いバージョン」の外部コマンドが利用できなければ、せっかくの解析結果が再現できなくなってしまいます。

### ルール4. 全てのカスタムスクリプトのバージョン管理
プログラムコードに微妙な修正によって、結果がまるで違うものになってしまうことがあります。大規模プログラムになればなるほど、どの（小さな）変更が最終的な結果に影響したのか不明になる事があります。

これに対応するためには、作成したコードの変更履歴を追跡することが必要です。Gitなどのバージョン管理ツールが有用です。また、そのようなツールを使わない場合には、do fileを作成する時に古いコードを削除するのではなく、コメントアウトするようにして下さい。また、変更した理由などを記録しておくことも有用です。

```stata
* 例
gen     x_cat = 0 if x < 0.5
// replace x_cat = 1 if x > 0.5 // 誤りのためコメントアウト
replace x_cat = 1 if x >0.5 & !missing(x)
```

### ルール5. 可能な限り全ての中間結果を記録する
全体結果が想定されたもので無いときに、中間的な結果を見ることで想定外の原因を知ることが出来るかも知れません。

これは1つのdo fileで解析の全てを賄うのではなく、モジュール化したdo fileで実行することと繋がりますが、各モジュールで中間的な結果を出しておけば、モジュール内で問題があるのか等を確認することが出来ます。

また、`log`コマンドでログを残しておくことも有用です。

```stata
capture log close
log using logfile.smcl, replace
command
...
log close
```

### ルール6. ランダム性がある解析では、シードを記録する。
BootstrapやMultiple imputationなどの乱数を用いた解析では、乱数を発生させるためのシードを固定し、それを記録して下さい。

```stata
set seed 123345
```

### ルール7. グラフ用のデータを保存する。
グラフを作成するためには、raw dataを変形し、グラフに適したデータ形式に変換しています。このようなグラフを描画するためのデータを保存しておくことも必要です。

グラフが想定外であった場合などは、このようなグラフ用データの記述統計量を確認することで何かエラーの原因が分かるかも知れません。

なお、グラフ描画のパラメータについても記録が必要ですが、Stataではdo file内に記録されているはずです。

### ルール8. 階層的な解析出力を作成し、確認しやすくする。
残念ながら、このルールについては、Stata単体で対応することは難しいかも知れません。Stata17以降でサポートされているJupyter notebookで対応することが良いと思いますが、本講義では取り扱いません。

RであればR markdownを使うことで対応できますし、PythonでもJupyter notebookなどで対応可能です。

### ルール9. 文章の根拠となる結果を結びつける
解析結果と論文に各文章を結びつける、というルールです。解析がシンプルであれば、これに問題が生じることは余り有りませんが、解析結果にバージョン違いが存在するとこの結合を誤ることがあります。

### ルール10. パブリックアクセスを提供する
入力データ、do file、ソフトのバージョンなどは、パブリックアクセスが可能なようにする必要があります。一部ジャーナルでは、データなどのパブリックアクセスが投稿条件である場合もあります。

ただし、入力データの公開には、個人情報保護などの問題がありますので、諸問題をクリアした上での公開してください。
 
