# 今回の目標
* 操作変数法について使う。
* 限界について知っておく。
* 操作変数をStataで実装する。

# 因果推論を行うために必要な条件
基本的な3つの条件について示します（基本とは・・・）。これについては、[Causal Inference: What If](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)を参照してください。というか、今回講義については、この本の16章を元にしています。

### 条件づき交換可能性（Conditional Exchangeability）

$$ Y^a \perp A | L $$

交絡 $L$ で条件付けると、潜在アウトカム $Y^a$ と曝露 $A$ が独立になるという意味です。つまり、 $L$ は必要なすべての交絡を含んでいる状態を指しています。

### 正値性（Positivity）

$$ Pr(A=1)≠0 $$

曝露確率はゼロではない。例えば、子宮筋腫を曝露とする研究においては男性を含んではいけません。男性は曝露確率がゼロであるためです。

### 一貫性（Consistency）

$$ E[Y^{a=1}=1] = E[Y=1|A=1] $$

$$ E[Y^{a=0}=1] = E[Y=1|A=0] $$

曝露ありの潜在アウトカムと、実際に曝露を受けた者のアウトカムのは等しく、同様に曝露なしの潜在アウトカムは、実際に曝露受けなかった者のアウトカムは等しいという意味です。

これは、曝露の明瞭な定義が行われないときに問題になります。例えば、体重減少を曝露とした場合、同じ体重減少であっても、「体重減少あり（運動した）」と「体重減少あり（食中毒）」のアウトカムが等しくなるはずは無く、consistensyに問題を生じます。

# 操作変数の3条件 + 1条件
上記のうち、条件づき交換可能性について、どうしても条件を満たせない場合があります。交絡する変数が存在していると分かっていても、測定できない・測定していない様な場合です。そのような時には、幾つかの方法が提案されていますが、下記の条件を満たす変数 $Z$ があれば、それを操作変数として、解析することで、因果推論を行うことができます。

1. $Z$ と $A$ が関連している。 $Cov(Z,A)≠0$ 。
2. $Z$ は $A$ を通して以外に $Y$ に影響を与えない。
3. $Z$ と $Y$ は共通原因を持たない。

[Causal Inference: What If](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)では、下記のようなDAGで説明されています。

![image](https://user-images.githubusercontent.com/67684585/224734454-f4ed4d9c-1d13-437c-aaa8-9b3380c40701.png)

Fig16.1は、王道の操作変数ですが、Fig16.2や16.3のようなパターンでも条件を満たしているので、利用可能です。

## 条件の確認
3つの条件のうち、1番目以外はデータから確認できないことに注意が必要です。

2番目の条件は、一見すると $A$ を条件付けて、 $Z$ と $Y$ の関連が残るかどうか？を確認すれば良い様に思いますが、これは無理な話です。 $A$ はコライダーになっていますので、 $A$ で条件付けると、 $Z→A←U→Y$ というパス（黄色パス）が開きますので、 $Z$ と $Y$ の関連性は残ります。

![image](https://user-images.githubusercontent.com/67684585/224737856-d7c2ed3f-cad9-4e67-b5f1-0325945ed679.png)


3番目の条件は、共通原因の不存在なので、ドメイン知識知識以外には役に立ちません。

## 4つ目の条件
上記の3条件で平均因果効果のBounds推定（今はそんなに重要ではない話なので割愛）はできますが、点推定はできません。

点推定を行うためには、下記の何れかが4つめの条件として必要です。

* 均質性（Homogeneity）
* 単調性（Monotonicity）

このうち、均質性は条件を満たされることが難しい、と考えられます（全くダメというわけではない）。

例えば、下記が成り立つ必要があります。

$$E[Y^{a=1}] - E[Y^{a=0}] = E[Y^{a=1}|U] - E[Y^{a=0}|U]$$

つまり、 $U$ がeffect modifierになっていないことが条件です。しかし、操作変数を用いているということは「どのような $U$ があるのか不明」という状況が多いと思います。そのような中で、「 $U$ は、どのような変数か不明だったり、測定できない変数であるが、それが効果修飾していない」という仮定を持つのはかなり不自然です。

また、実装する時にも、共変量を含んだ統計的手法で対応する必要があります。ですが、そもそも操作変数を用いるモチベーションの1つは、**共変量が測定できないこと**だったはずです。なので、共変量を含んだ操作変数法による解析はかなり無理がある想定だと考えています。

そのため、ここでは後者の**単調性 Monotonicity**を仮定した話を行います。

## 単調性 Monotonicity とは？

### 4つの反応タイプ

$A^z$ について考えます。これは、操作変数Zが与えられたときの潜在的な曝露状態を表しています。 $A$ と $Z$ がそれぞれ二値であれば、その状態に併せて4パターンの反応があります。

* Always takers： $Z$ の状態にかかわらず常に曝露を受けるという人達です。 $A^{z=1}=1$ かつ $A^{z=0}=1$
* Compliers： $Z=1$ では曝露を受け、 $Z=0$ では曝露を受けないという人達です（一番期待される反応）。 $A^{z=1}=1$ かつ $A^{z=0}=0$
* Defiers： $Z=1$ では曝露を受けず、 $Z=0$ では曝露を受けるという人達です（天邪鬼な反応）。 $A^{z=1}=0$ かつ $A^{z=0}=1$
* Never takers： $Z$ の状態にかかわらず常に曝露を受けないという人達です。 $A^{z=1}=0$ かつ $A^{z=0}=0$

なお、データからは、この4つのうちどれに当てはまっているのかはわかりません。

例えば、 $Z=1, A=1$ というデータがあったとしても、その人が、Always takersなのかCompliersなのか判断できません（下表参照）。

![image](https://user-images.githubusercontent.com/67684585/224741428-106106c9-91d1-4511-9c64-0c0492da8c0f.png)

### 単調性 Monotonicity とは？

Defiersが存在しないという仮定です。もし、Difiersがいなければ下記の不等式が成り立ちます。

$$A^{z=1} ≥ A^{z=0}$$

この式が単調増加なので、単調性という名称と繋がったと思います。

# 操作変数法によるEstimand
操作変数では、下記の式によりIV estimandが計算されます。

$$ \dfrac{E[Y|Z=1] - E[Y|Z=0]}{E[A|Z=1]-E[A|Z=0]} $$

## 分子を考えると…
分子は、 $Z$ が $Y$ に与える影響を推定しています。

Always takerやNever takerはこの効果がゼロになります。これは、アウトカムに影響を与えるのは実質的にZではなく、Aであるということが関係しています。Aの値が同じであればアウトカムYは同じ値になります。

例えば、Always takerでは、

$$ E[Y|Z=1] - E[Y|Z=0] $$

$$ E[Y|A=1, Z=1] - E[Y|A=1, Z=0] $$

$$ E[Y|A=1] - E[Y|A=1] = 0$$

となり、ゼロになります。

そのため、分子で残るのは「Complierにおいて、 $Z$ が $Y$ に与える影響」のみです。

## 分母を考えると…
分母は、標本集団に含まれるComplierの割合になります。

確かめてみましょう。

![image](https://user-images.githubusercontent.com/67684585/224741428-106106c9-91d1-4511-9c64-0c0492da8c0f.png)

上の式から、下記の様に変形できます（Defiersがいないという条件にて）。

$$ E[A|Z=1] - E[A|Z=0] = Pr(always-takers) + Pr(compliers) - Pr(always-takers) = Pr(compliers) $$

# 前振りを終えて、操作変数法のStataによる実装（1）
例によって、`nhefs.dta`を用いた解析を行います。
下記の様に設定します。

* 操作変数：タバコ価格（`price82`）
* 曝露：禁煙の有無（`qsmk`）
* アウトカム：体重変化（`wt82_71`）

タバコ価格は連続量ですので、1.5ドルをカットオフとします。

```
use nhefs.dta, clear
drop if price82 == .
drop if wt82_71 == .

gen highprice = (price82 > 1.5) 
label define price 0 "low" 1 "highW
label values highprice price

```

まず、IV estimandの式に当てはめてみたいと思います。

$$ \dfrac{E[Y|Z=1] - E[Y|Z=0]}{E[A|Z=1]-E[A|Z=0]} $$


```
* 分子の計算
ttest wt82_71, by(highprice) rev

* 分母の計算
tab highprice qsmk, row
```

最初の`ttest`コマンドで、 $Z$ が $Y$ に与える効果を算出しました。約0.150kgという結果です。

次の`tab`コマンドでは、 $Z$ と $A$ の関係を出しています。分母は $0.2578 - 0.1951 = 0.0627$となります。

これを割り算すると、IV estimandが求まります。

```
* 割り算
di 0.1502887/(0.2578 - 0.1951)
```

この結果、禁煙による体重変化は、約2.40kgと推定されました。

この値は、他の方法（重回帰:3.38kg、IPTW:3.58kg, G-estimation:3.45kg）とは、結構ちがうということに気をつけて下さい。

# 前振りを終えて、操作変数法のStataによる実装（2）
次は、専用コマンドで

